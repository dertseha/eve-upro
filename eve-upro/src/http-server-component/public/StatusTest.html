<html>
<head>
   <meta "http-equiv='X-UA-Compatible' content='IE=9'" />
   <title>Status Test</title>
   <script type="text/javascript" charset="utf-8" src="/javascripts/release/prototype.js"></script>
   <script type="text/javascript" charset="utf-8" src="/javascripts/EventSource.js"></script>
</head>
<body>
   Hello there!
   <div id='test'></div>


   <script language="JavaScript">

   var sessionId = null;

   var sendStatus = function()
   {
      console.log('send status');

      var request = new Ajax.Request("http://localhost:3000/requestSink/",
      {
         method: "post",
         overrideMimeType: true,
        //parameters: JSON.stringify({ jsonrpc: "2.0", method: "clientRequest", id: 1}),
         postBody: JSON.stringify({ jsonrpc: "2.0", method: "clientRequest", params:
         {
            header:
            {
               type: "Status",
               sessionId: sessionId
            },
            body:
            {

            }
         }, id: 1}),
         contentType: 'application/json',
         onSuccess: function(response)
         {
            //console.log('success: ' + JSON.stringify(response));
//            var elem = document.getElementById("test");
//            elem.innerHTML += JSON.stringify(response.responseJSON);
         },
        onFailure: function(response)
        {
            console.log('failure: ' + JSON.stringify(response));
        }
      });
   }

   var elem = document.getElementById("test");


   elem.innerHTML += "starting event ";

   var evtSrc = new EventSource( "eventSource" );

   evtSrc.addEventListener("Timer", function( e )
   {
//      addMessage( JSON.parse(e.data) );
   }, false);
   evtSrc.addEventListener("Session", function( e )
   {
      var data = JSON.parse(e.data);

      sessionId = data.sessionId;
      console.log('retrieved sessionId: ' + sessionId);

      //sendStatus();
      setInterval(sendStatus, 5000);
      //addMessage( e.data );
   }, false);
   evtSrc.addEventListener("Broadcast", function( e )
   {
      var message = e.data.evalJSON(true);

      onBroadcast( message.header, message.body );
   }, false);

   function addMessage( data )
   {
      console.log(data);

      var paragraph = document.createElement("p");
      paragraph.appendChild(document.createTextNode(data));
      document.body.appendChild(paragraph);
   }

   var statusParagraph = document.createElement("p");
   document.body.appendChild(statusParagraph);

   var characters = {};

   function onBroadcast(header, body)
   {
      console.log('got status');
      if (header.type == 'CharacterLocationStatus')
      {
         onBroadcastCharacterLocationStatus(header, body);
      }

      //statusParagraph.innerHTML = data;
   }

   function onBroadcastCharacterLocationStatus(header, body)
   {
      var charId = body.characterInfo.characterId;
      var character = characters[charId];

      if (!character)
      {
         characters[charId] = character = document.createElement("p");
         statusParagraph.appendChild(character);
      }
      character.innerHTML = body.characterInfo.characterName + ': ' + body.solarSystemId;
   }


   </script>

</body>
</html>